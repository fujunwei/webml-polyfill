<html>
  <head>
    <meta charset="utf-8">
    <title>Onnx Importer Test</title>
  </head>
  <body>
    <script src="../../dist/webml-polyfill.js"></script>
    <script src="../third_party/protobuf.min.js"></script>
    <script src="../util/base.js"></script>
    <script src="onnx.js"></script>
    <script src="OnnxModelUtils.js"></script>
    <script src="SqueezeNet.js"></script>
    <script>
     window.onload = async function() {
      async function loadUrl(url) {
        return new Promise((resolve, reject) => {
          let request = new XMLHttpRequest();
          request.open('GET', url, true);
          request.responseType = 'arraybuffer';
          request.onload = _ => {
            if (request.readyState === 4)
              if (request.status === 200)
                resolve(new Uint8Array(request.response));
              else
                reject(new Error('Failed to load ' + url));
          };
          request.send();
        });
      }
      const INPUT_TENSOR_SIZE = 1*2*3*3;
      const OUTPUT_TENSOR_SIZE = 1*2*3*3;
      const MODEL_FILE = './model/testbn.onnx';
      const backend = 'WebML';

      // [[[[2.6420, 0.5284, 0.5284],
      //     [0.5284, 0.5284, 0.5284],
      //     [0.5284, 0.5284, 0.5284]],

      //    [[0.4365, 0.4365, 0.4365],
      //     [0.4365, 0.4365, 0.4365],
      //     [0.4365, 0.4365, 0.4365]]]]

      // sum: 10.797325134277344

      let inputTensor = new Float32Array(INPUT_TENSOR_SIZE);
      let outputTensor = new Float32Array(OUTPUT_TENSOR_SIZE);
      for (let i = 0; i < inputTensor.length; ++i)
        inputTensor[i] = 1;
      inputTensor[0] = 5;

      let result = await loadUrl(MODEL_FILE);
      if (onnx.ModelProto.verify(result))
        throw new Error(`Invalid model`);
      let onnxModel = onnx.ModelProto.decode(result);
      printOnnxModel(onnxModel);
      
      
      let model = new SqueezeNet(onnxModel, backend);
      result = await model.createCompiledModel();
      result = await model.compute(inputTensor, outputTensor);
      console.log(backend);
      console.log(outputTensor.reduce((x,y) => x + y));
      // console.log(inputTensor);
      // console.log(outputTensor);
    }
    </script>
  </body>
</html>
