<html>
  <head>
    <meta charset="utf-8">
    <title>Onnx Ops Inspector</title>
  </head>
  <body>
    <div id='result'></div>
    <script src="../../dist/webml-polyfill.js"></script>
    <script src="../third_party/protobuf.min.js"></script>
    <script src="../util/base.js"></script>
    <script src="onnx.js"></script>
    <script src="OnnxModelUtils.js"></script>
    <script src="SqueezeNet.js"></script>
    <script>
     window.onload = async function() {
      async function loadUrl(url) {
        return new Promise((resolve, reject) => {
          let request = new XMLHttpRequest();
          request.open('GET', url, true);
          request.responseType = 'arraybuffer';
          request.onload = _ => {
            if (request.readyState === 4)
              if (request.status === 200)
                resolve(new Uint8Array(request.response));
              else
                reject(new Error('Failed to load ' + url));
          };
          request.send();
        });
      }
      const models = {
        'AlexNet': 'alexnet.onnx',
        'CaffeNet': 'caffenet.onnx',
        'DenseNet-121': 'densenet121.onnx',
        'GoogleNet': 'googlenet.onnx',
        'Inception v1': 'inception_v1.onnx',
        'Inception v2': 'inception_v2.onnx',
        'MobileNet v2-1.0': 'mobilenetv2.onnx',
        'R-CNN ILSVRC13': 'rcnn_ilsvrc13.onnx',
        'ResNet-152v1': 'resnet152v1.onnx',
        'ResNet-152v2': 'resnet152v2.onnx',
        'ShuffleNet': 'shufflenet.onnx',
        'SqueezeNet': 'squeezenet.onnx',
        'ZFNet-512': 'zfnet512.onnx',
      }
      let allOps = new Set();
      let modelOps = {}
      for (let m in models) {
        console.log(`Loading ${m}`);
        let result = await loadUrl('./model/' + models[m]);
        if (onnx.ModelProto.verify(result))
          throw new Error(`Invalid model`);
        let onnxModel = onnx.ModelProto.decode(result);
        let set = Array.from(new Set(onnxModel.graph.node.map(n=>n.opType)));
        modelOps[m] = set;
        set.forEach(o => allOps.add(o));
      }
      allOps = Array.from(allOps);
      function appendHTML(buf) {
        document.getElementById('result').innerHTML += buf + '<br>';
      }
      appendHTML('|Model \\ Ops|' + allOps.join('|') + '|');
      appendHTML('|-|' + allOps.map(_ => '-|').join(''));
      for (let m in modelOps)
        appendHTML(`|${m}|` + allOps.map(o => modelOps[m].includes(o) ? 'âœ“|' : ' |').join(''));
    }
    </script>
  </body>
</html>
