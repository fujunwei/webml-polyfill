<html>
  <head>
    <meta charset="utf-8">
    <title>WebML Polyfill | Mocha Tests</title>
  </head>
  <body>
    <div id="mocha"></div>
    <div> <input type="button" onclick="predict()" value="button"></div>
    <div> <input type="file"  id="inputData"></div>
    <textarea id="textarea" rows=100 cols=100></textarea>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!--script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/4.0.1/mocha.min.js"></script-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/5.2.0/mocha.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.1.2/chai.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.min.js"></script>
    <script src="../../dist/webml-polyfill.js"></script>
    <script src="../utils.js"></script>
    <script>
      window.onload = setOptions;
    </script>
    <script>
      mocha.setup('bdd');
    </script>
    <!--script src="./cts/test/V1_0/avg_pool_float_2.js"></script-->
    <!--script src="./cts/test/V1_0/resize_bilinear.js"></script-->
    <!--script src="./cts/test/V1_0/conv_float.js"></script-->
    <!--script src="./cts/test/V1_0/add.js"></script-->
    <!-- <script src="./cts/test/V1_0_plus/depthwise_conv_relu.js"></script> -->
    <!--script src="./cts/test/V1_0/depthwise_conv2d_float_large_2.js"></script-->
    <script>

      // window.mochaFinish = false;
      // mocha.globals(['jQuery']);
      // mocha.run(function() {window.mochaFinish = true});


var primary_data, secondary_data, expected_data, outputData;
      function predict() {

describe('CTS', function() {
        const assert = chai.assert;
  const nn = navigator.ml.getNeuralNetworkContext();

  it('check result for Depthwise conv relu example-1', async function() {
    let model = await nn.createModel(options);

    const type0 = {type: nn.TENSOR_FLOAT32, dimensions: [1, 112, 112, 2]};
    const type1 = {type: nn.TENSOR_FLOAT32, dimensions: [1, 1, 2]};
    const type2 = {type: nn.TENSOR_FLOAT32, dimensions: [1, 112, 112, 2]};
    const length = product(type2.dimensions);

    let operandIndex = 0;
    let fusedActivationFuncNone = operandIndex++;
    model.addOperand({type: nn.INT32});
    model.setOperandValue(fusedActivationFuncNone, new Int32Array([nn.FUSED_NONE]));


    let input0 = operandIndex++;
    model.addOperand(type0);

    let input1 = operandIndex++;
    model.addOperand(type1);

    var new_input_data = new Float32Array(2);
    for (var i = 0; i < length; i++) {
        new_input_data[i] = secondary_data[i];
    }
    console.log(new_input_data.length);
    model.setOperandValue(input1, new_input_data);

    let output = operandIndex++;
    model.addOperand(type2);

    model.addOperation(nn.MUL, [input0, input1, fusedActivationFuncNone], [output]);
    model.identifyInputsAndOutputs([input0], [output]);
    await model.finish();

    let compilation = await model.createCompilation();
    compilation.setPreference(getPreferenceCode(options.prefer));
    await compilation.finish();

    let execution = await compilation.createExecution();
    new_input_data = new Float32Array(length);
    for (var i = 0; i < length; i++) {
        new_input_data[i] = primary_data[i];
    }
    console.log(new_input_data.length);
    let op2_input = new Float32Array(new_input_data);
    execution.setInput(0, op2_input);
    outputData = new Float32Array(length);
    execution.setOutput(0, outputData);
    await execution.startCompute();

    for (let i = 0; i < length; ++i) {
      if(!almostEqualCTS(outputData[i], expected_data[i])) {
        console.log("index: " + i + " op3_output " + outputData[i] + " expected_data " + expected_data[i]);
        break;
      }
    }
    
    let sum = 0;
      for (let i = 0; i < length; i++) {
        sum += Math.pow(outputData[i] - expected_data[i], 2);
      }
      console.log(`var: ${sum / length}`);
});
});



window.mochaFinish = false;
      mocha.globals(['jQuery']);
      mocha.run(function() {window.mochaFinish = true});
}


var i = 0;
// <textarea id="textarea" rows=100 cols=100></textarea>
// var textarea = document.getElementById("textarea")
// textarea.value=
inputData.addEventListener('change', function(e) {
            var file = inputData.files[0];
            var textType = /text.*/;

            if (file.type.match(textType)) {
                var reader = new FileReader();

                reader.onload = function(e) {
                    var text = reader.result;
                    var arr = text.split(",");
                    var file_data = new Float32Array(arr.length);
                    for(j in arr) {
                       var b = parseFloat(arr[j]);
                       file_data[j] = b;
                    }

                   if (i == 0) {
                      primary_data = file_data;
                    } else if (i == 1) {
                        secondary_data = file_data;
                    } else if (i == 2) {
                        expected_data = file_data;
                    }
                    i++;
                   console.log(file_data.length);
                }

                reader.readAsText(file);    
            } else {
                fileDisplayArea.innerText = "File not supported!"
            }
        });
    </script>
  </body>
</html>
