<html>
  <head>
    <meta charset="utf-8">
    <title>WebML Polyfill | Mocha Tests</title>
  </head>
  <body>
    <div id="mocha"></div>
    <div> <input type="button" onclick="predict()" value="button"></div>
    <div> <input type="file"  id="inputData"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!--script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/4.0.1/mocha.min.js"></script-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/5.2.0/mocha.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.1.2/chai.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.min.js"></script>
    <script src="../dist/webml-polyfill.js"></script>
    <script src="./utils.js"></script>
    <script>
      window.onload = setOptions;
    </script>
    <script>
      mocha.setup('bdd');
    </script>
    <!--script src="./cts/test/V1_0/avg_pool_float_2.js"></script-->
    <!--script src="./cts/test/V1_0/resize_bilinear.js"--></script>
    <!--script src="./cts/test/V1_0/conv_float.js"></script-->
    <!--script src="./cts/test/V1_0/add.js"></script-->
    <!--script src="./cts/test/V1_0_plus/depthwise_conv_relu.js"></script-->
    <!--script src="./cts/test/V1_0/depthwise_conv2d_float_large_2.js"></script-->
    <script>
/*
      window.mochaFinish = false;
      mocha.globals(['jQuery']);
      mocha.run(function() {window.mochaFinish = true});
*/   

var input_data, weights_data, bais_data, output_data;
      function predict() {

describe('CTS', function() {
        const assert = chai.assert;
  const nn = navigator.ml.getNeuralNetworkContext();

  it('check result for Depthwise conv relu example-1', async function() {
    let model = await nn.createModel(options);
    let operandIndex = 0;

    let op2_value = [-0.869931, 0.644628, -0.918393, 0.153672, 0.868562, -0.358177, -0.134931, -0.247565, 0.22174, -0.259157, -0.284296, -0.538065, 0.765559, 0.41986, -0.556241, 0.658494, 0.214355, -0.850169, -0.252893, -0.478935, 0.530526, -0.0700663, -0.988729, -0.303061, 0.150845, 0.829915, 0.476349, 0.406537, -0.355343, 0.757145, -0.356362, 0.800482, -0.713861, 0.210483, -0.634303, 0.718236, -0.752038, 0.457547, -0.550769, -0.551178, 0.446766, -0.227462, 0.216348, -0.852806, -0.351486, 0.55906, -0.668493, -0.303493, -0.363763, -0.162837, 0.0701012, 0.756097, -0.142269, 0.329724, -0.656317, -0.998086, -0.652949, -0.40316, -0.893682, 0.432744, 0.612362, -0.869588, -0.71327, -0.398092, -0.0423559, 0.436576, -0.925272, 0.176549, 0.822904, 0.096833, -0.296802, -0.427195, 0.031654, -0.254479, 0.244905, 0.0948254, 0.643769, -0.90391, 0.352665, -0.901179, 0.266159, -0.968068, -0.615401, -0.388975, 0.939052, -0.116289, 0.107523, -0.0582711, 0.435172, 0.334675, 0.459711, 0.717436, 0.496627, -0.680175, -0.415066, 0.339848, 0.506004, -0.337808, -0.107218, -0.172496, 0.870638, 0.931872, -0.953884, 0.903042, 0.760078, 0.209727, -0.285384, -0.45514, 0.113194, 0.0756611, 0.0924435, -0.472863, 0.960609, -0.160385, -0.839445, 0.457097, 0.163348, 0.344867, -0.131619, 0.688715, -0.540827, 0.571259, -0.95587, 0.506164, -0.155839, 0.0789621, 0.756772, -0.662069, 0.242908, 0.460821, 0.177872, -0.289839, -0.640603, 0.702598, -0.506406, -0.568262, -0.0713716, 0.413792, 0.159673, -0.305208, 0.133816, -0.160254, 0.787323, -0.753244, 0.600721, 0.263186, -0.162387, 0.477962, -0.702951, -0.731036, -0.939481, -0.524519, 0.934072, -0.511637, -0.503499, 0.106236, -0.323684, 0.534444, -0.843745, 0.364171, 0.0370358, -0.168801, -0.404559, -0.814178, 0.91745, -0.334276, 0.66925, -0.801201, 0.156511, -0.427949, 0.379153, 0.818597, -0.649902, 0.427087, -0.586015, -0.559789, -0.833923, 0.0892409, -0.621251, 0.213826, 0.465509, 0.4704, 0.380261, 0.413067, 0.180822, 0.172866, 0.59614, 0.825575, 0.662916, -0.704381, -0.297631, 0.697778];
    let op3_expect = [0.8405386209487915, 0, 0.7549465894699097, 0, 0, 0.29443225264549255, 0.1303720772266388, 0.11573020368814468, 0, 0.2504008710384369, 0.13290099799633026, 0.4423055946826935, 0, 0, 0.4572467803955078, 0, 0, 0.6988644599914551, 0.24434849619865417, 0.22388966381549835, 0, 0.06769897043704987, 0.46220511198043823, 0.24912524223327637, 0, 0, 0, 0, 0.16611362993717194, 0, 0.3443215787410736, 0, 0.5868151783943176, 0, 0.2965201437473297, 0, 0.7266288995742798, 0, 0.4527486264705658, 0.532555341720581, 0, 0.18698059022426605, 0, 0.3986646234989166, 0.28893202543258667, 0, 0.3125030994415283, 0.24948035180568695, 0.35147252678871155, 0.07612206786870956, 0, 0, 0.06650706380605698, 0, 0.6341419816017151, 0.46657925844192505, 0.5367436408996582, 0.389538437128067, 0.41777312755584717, 0, 0, 0.40650978684425354, 0.5863293409347534, 0.3846416771411896, 0.019800281152129173, 0, 0.8940098285675049, 0, 0, 0, 0.1387472301721573, 0.35116711258888245, 0, 0.11896231770515442, 0, 0, 0, 0.7430411577224731, 0, 0.4212777614593506, 0, 0.9353598952293396, 0.28768399357795715, 0.319749116897583, 0, 0.054362084716558456, 0, 0.05630229413509369, 0, 0, 0, 0, 0, 0.6571938991546631, 0.19403256475925446, 0, 0, 0.15791647136211395, 0.08813641220331192, 0.1666678786277771, 0, 0, 0.9216551184654236, 0, 0, 0, 0.13340960443019867, 0.374138742685318, 0, 0, 0, 0.456886351108551, 0, 0.1318412870168686, 0.811082661151886, 0, 0, 0, 0.061528466641902924, 0, 0.5225540399551392, 0, 0.7857537865638733, 0, 0.07285068184137344, 0, 0, 0.3095000684261322, 0, 0, 0, 0.23825635015964508, 0.6189589500427246, 0, 0.41628092527389526, 0.5490621328353882, 0.03336436673998833, 0, 0, 0.14267680048942566, 0, 0.15483950078487396, 0, 0.6191891431808472, 0, 0, 0.13348698616027832, 0, 0.3286113440990448, 0.6009335517883301, 0.9077387452125549, 0.24519900977611542, 0, 0.49435028433799744, 0.23537269234657288, 0, 0.31274768710136414, 0, 0.6935837268829346, 0, 0, 0.13875947892665863, 0.3908901512622833, 0.3806070387363434, 0, 0.3229818046092987, 0, 0.6586112380027771, 0, 0.2000550478696823, 0, 0, 0.30381229519844055, 0, 0.5662152767181396, 0.2616868019104004, 0.6855097413063049, 0, 0.29041868448257446, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.6805820465087891, 0.1391347497701645, 0];

    let type0 = {type: nn.INT32};
    let type2 = {type: nn.TENSOR_FLOAT32, dimensions: [1, 1, 1, 3]};
    let type2_length = product(type2.dimensions);
    let type1 = {type: nn.TENSOR_FLOAT32, dimensions: [1, 8, 8, 3]};
    let type1_length = product(type1.dimensions);
    let type3 = {type: nn.TENSOR_FLOAT32, dimensions: [3]};
    let type3_length = product(type3.dimensions);

    let b4 = operandIndex++;
    model.addOperand(type0);
    let b5 = operandIndex++;
    model.addOperand(type0);
    let b6 = operandIndex++;
    model.addOperand(type0);
    let b7 = operandIndex++;
    model.addOperand(type0);
    let b8 = operandIndex++;
    model.addOperand(type0);
    let op2 = operandIndex++;
    model.addOperand(type1);
    let op3 = operandIndex++;
    model.addOperand(type1);
    let op0 = operandIndex++;
    model.addOperand(type2);
    let op1 = operandIndex++;
    model.addOperand(type3);

    model.setOperandValue(b4, new Int32Array([1]));
    model.setOperandValue(b5, new Int32Array([1]));
    model.setOperandValue(b6, new Int32Array([1]));
    model.setOperandValue(b7, new Int32Array([1]));
    model.setOperandValue(b8, new Int32Array([1]));
    model.setOperandValue(op0, new Float32Array([-0.966213, -0.467474, -0.82203]));
    model.setOperandValue(op1, new Float32Array([0, 0, 0]));
    model.addOperation(nn.DEPTHWISE_CONV_2D, [op2, op0, op1, b4, b5, b6, b7, b8], [op3]);

    model.identifyInputsAndOutputs([op2], [op3]);
    await model.finish();

    let compilation = await model.createCompilation();
    compilation.setPreference(prefer);
    await compilation.finish();

    let execution = await compilation.createExecution();

    let op2_input = new Float32Array(op2_value);
    execution.setInput(0, op2_input);

    let op3_output = new Float32Array(type1_length);
    execution.setOutput(0, op3_output);

    await execution.startCompute();

    for (let i = 0; i < type1_length; ++i) {
      assert.isTrue(almostEqualCTS(op3_output[i], op3_expect[i]));
    }
});
});



window.mochaFinish = false;
      mocha.globals(['jQuery']);
      mocha.run(function() {window.mochaFinish = true});
}


var i = 0;

inputData.addEventListener('change', function(e) {
            var file = inputData.files[0];
            var textType = /text.*/;

            if (file.type.match(textType)) {
                var reader = new FileReader();

                reader.onload = function(e) {
                    var text = reader.result;
                    var arr = text.split(",");
                    var file_data = new Float32Array(arr.length);
                    for(j in arr) {
                       var b = parseFloat(arr[j]);
                       file_data[j] = b;
                    }
                  
                   // new_float_array = new Float32Array(origin_float_array);
                   // var width = 513, height = 513, depth = 21;
                   // for (var c = 0; c < depth; c++) {
                   //   for (var h = 0; h < height; h++) {
                   //     for (var w = 0; w < width; w++) {
                   //       new_float_array[c +
                   //                         h * width * depth + w * depth] =
                   //       origin_float_array[c * width * height + h * width + w];
                   //     }
                   //   }
                   // }

                   if (i == 0) {
                      input_data = file_data;
                    } else if (i == 1) {
                        weights_data = file_data;
                    } else if (i == 2) {
                        bais_data = file_data;
                    } else if (i == 3) {
                        output_data = file_data;
                    }
                    i++;
                   console.log(file_data.length);
                }

                reader.readAsText(file);    
            } else {
                fileDisplayArea.innerText = "File not supported!"
            }
        });
    </script>
  </body>
</html>
